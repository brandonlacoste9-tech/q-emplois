generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  client
  provider
  admin
}

enum LanguagePreference {
  fr
  en
}

enum BookingStatus {
  pending
  confirmed
  in_progress
  completed
  cancelled
}

enum PriceUnit {
  hour
  job
}

// ========================
// USER MODEL - Loi 25 Compliance
// ========================
model User {
  id                  String             @id @default(uuid())
  email               String             @unique
  emailEncrypted      String?            // Encrypted email for Law 25
  phone               String?            @unique
  phoneEncrypted      String?            // Encrypted phone for Law 25
  passwordHash        String
  
  role                UserRole           @default(client)
  languagePreference  LanguagePreference @default(fr)
  
  // Law 25 Compliance Fields
  consentGiven        Boolean            @default(false)
  consentDate         DateTime?
  dataRetentionDate   DateTime?          // Auto-delete after this date
  lastAccessAt        DateTime?          // Track last access for retention policy
  
  // Profile
  firstName           String?
  lastName            String?
  
  // Timestamps
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  deletedAt           DateTime?          // Soft delete for Law 25
  
  // Relations
  provider            Provider?
  clientBookings      Booking[]          @relation("ClientBookings")
  clientReviews       Review[]           @relation("ClientReviews")
  auditLogs           AuditLog[]
  
  // Bot integrations
  telegramId          String?            @unique
  whatsappId          String?            @unique

  @@index([email])
  @@index([role])
  @@index([dataRetentionDate])
  @@index([deletedAt])
  @@map("users")
}

// ========================
// PROVIDER MODEL
// ========================
model Provider {
  id                 String   @id @default(uuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Service specialization
  serviceTypes       String[] // ["Plomberie", "Électricité", "Menuiserie", ...]
  
  // Professional info
  licenseNumber      String?
  licenseDocumentUrl String?
  isVerified         Boolean  @default(false)
  verifiedAt         DateTime?
  
  // Ratings
  rating             Float    @default(0)
  reviewCount        Int      @default(0)
  
  // Pricing
  hourlyRate         Decimal? @db.Decimal(10, 2)
  serviceRadiusKm    Int      @default(25)
  
  // Availability (JSON for flexible schedule)
  availabilityJson   String?  // JSON: {"monday": [{"start": "09:00", "end": "17:00"}], ...}
  
  // Location
  locationLat        Decimal? @db.Decimal(10, 8)
  locationLng        Decimal? @db.Decimal(11, 8)
  locationAddress    String?
  
  // Timestamps
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  // Relations
  bookings           Booking[] @relation("ProviderBookings")
  reviews            Review[] @relation("ProviderReviews")
  earnings           Earning[]

  @@index([userId])
  @@index([serviceTypes])
  @@index([isVerified])
  @@index([locationLat, locationLng])
  @@map("providers")
}

// ========================
// SERVICE MODEL
// ========================
model Service {
  id          String    @id @default(uuid())
  name        String
  nameFr      String    // French name (Bill 96 compliance)
  category    String    // "Plomberie", "Électricité", etc.
  description String?
  descriptionFr String?
  
  // Pricing
  basePrice   Decimal   @db.Decimal(10, 2)
  priceUnit   PriceUnit @default(hour)
  
  // UI
  icon        String?   // Icon identifier or URL
  isActive    Boolean   @default(true)
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  bookings    Booking[]

  @@index([category])
  @@index([isActive])
  @@map("services")
}

// ========================
// BOOKING MODEL (State Machine)
// ========================
model Booking {
  id              String        @id @default(uuid())
  
  // Relations
  clientId        String
  client          User          @relation("ClientBookings", fields: [clientId], references: [id], onDelete: Cascade)
  
  providerId      String
  provider        Provider      @relation("ProviderBookings", fields: [providerId], references: [id], onDelete: Cascade)
  
  serviceId       String
  service         Service       @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  
  // Status (State Machine)
  status          BookingStatus @default(pending)
  statusHistory   Json?         // Track status changes: [{"status": "pending", "at": "...", "by": "..."}, ...]
  
  // Scheduling
  scheduledDate   DateTime
  durationHours   Decimal       @db.Decimal(4, 2)
  
  // Location
  locationAddress String
  locationLat     Decimal?      @db.Decimal(10, 8)
  locationLng     Decimal?      @db.Decimal(11, 8)
  
  // Pricing
  priceEstimate   Decimal       @db.Decimal(10, 2)
  finalPrice      Decimal?      @db.Decimal(10, 2)
  
  // Payment
  stripePaymentIntentId String?
  paymentStatus     String      @default("pending") // pending, processing, completed, failed, refunded
  
  // Description
  description       String?     // Client's description of the job
  
  // Timestamps
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  confirmedAt       DateTime?
  startedAt         DateTime?
  completedAt       DateTime?
  cancelledAt       DateTime?
  cancellationReason String?
  
  // Relations
  review            Review?

  @@index([clientId])
  @@index([providerId])
  @@index([serviceId])
  @@index([status])
  @@index([scheduledDate])
  @@map("bookings")
}

// ========================
// REVIEW MODEL
// ========================
model Review {
  id          String   @id @default(uuid())
  
  bookingId   String   @unique
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  providerId  String
  provider    Provider @relation("ProviderReviews", fields: [providerId], references: [id], onDelete: Cascade)
  
  clientId    String
  client      User     @relation("ClientReviews", fields: [clientId], references: [id], onDelete: Cascade)
  
  rating      Int      // 1-5
  comment     String?
  
  createdAt   DateTime @default(now())

  @@index([providerId])
  @@index([clientId])
  @@index([bookingId])
  @@map("reviews")
}

// ========================
// EARNING MODEL (Provider earnings)
// ========================
model Earning {
  id              String   @id @default(uuid())
  providerId      String
  provider        Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  
  bookingId       String?
  amount          Decimal  @db.Decimal(10, 2)
  platformFee     Decimal  @db.Decimal(10, 2) // Q-Emplois commission
  netAmount       Decimal  @db.Decimal(10, 2)
  
  status          String   @default("pending") // pending, paid, disputed
  paidAt          DateTime?
  
  createdAt       DateTime @default(now())

  @@index([providerId])
  @@index([status])
  @@map("earnings")
}

// ========================
// AUDIT LOG (Law 25 Compliance)
// ========================
model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action      String   // "login", "data_access", "data_modification", "deletion_request", etc.
  resource    String   // "user", "booking", "payment", etc.
  resourceId  String?
  details     Json?    // Additional context
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}